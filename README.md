# KazStreamLink: Конвертер RTMP в RTSP

Простой сервис для конвертации видеопотоков из формата RTMP в формат RTSP.
Сервис использует FFmpeg для фактической конвертации и предполагает, что для раздачи RTSP-потока используется отдельный RTSP-сервер, такой как [mediamtx](https://github.com/bluenviron/mediamtx) (ранее известный как rtsp-simple-server).

## 1. Требования

*   **Python 3.6+**
*   **FFmpeg**: Установлен и доступен в системном `PATH`.
*   **RTSP-сервер** (рекомендуется mediamtx): Запущен и настроен для приема потоков. По умолчанию mediamtx слушает на порту `8554`.

## 2. Установка и настройка

### 2.1. Клонирование проекта (если применимо)
```bash
git clone <URL_репозитория_KazStreamLink>
cd KazStreamLink
```

### 2.2. Установка FFmpeg
Инструкции по установке FFmpeg зависят от вашей операционной системы:
*   **Windows**: Скачайте сборку с [официального сайта FFmpeg](https://ffmpeg.org/download.html) и добавьте путь к `ffmpeg.exe` в переменную окружения `PATH`.
*   **Linux (Ubuntu/Debian)**:
    ```bash
    sudo apt update
    sudo apt install ffmpeg
    ```
*   **macOS (используя Homebrew)**:
    ```bash
    brew install ffmpeg
    ```

### 2.3. Установка и запуск RTSP-сервера (mediamtx)
1.  Скачайте последнюю версию mediamtx для вашей ОС со страницы [релизов mediamtx](https://github.com/bluenviron/mediamtx/releases).
2.  Распакуйте архив и запустите исполняемый файл `mediamtx` (или `mediamtx.exe` для Windows).
    ```bash
    ./mediamtx
    ```
    По умолчанию mediamtx будет слушать RTSP-соединения на порту `8554` и RTMP на `1935`. Конфигурационный файл `mediamtx.yml` позволяет настроить эти и другие параметры. Для нашего случая, Python-скрипт будет отправлять поток на `rtsp://127.0.0.1:8554/имя_потока`.

## 3. Запуск конвертера

Проект предоставляет веб-интерфейс на базе Streamlit для управления конвертациями.

### 3.1. Локальный запуск (без Docker)

1.  **Установите Streamlit и другие зависимости** (если еще не установлены):
    ```bash
    pip install streamlit
    ```
    (Предполагается, что Python и FFmpeg уже установлены согласно разделу 2).

2.  **Запустите RTSP-сервер** (например, `mediamtx`) вручную, если он еще не запущен.

3.  **Запустите Streamlit приложение:**
    Из корневой директории проекта `KazStreamLink` выполните:
    ```bash
    streamlit run streamlit_app.py
    ```
    После этого в вашем браузере должна открыться страница приложения (обычно по адресу `http://localhost:8501`).

4.  **Использование интерфейса:**
    *   На странице будет форма для добавления новой конвертации.
        *   **RTMP URL источника**: Укажите ваш RTMP-поток.
        *   **Хост RTSP-сервера (для FFmpeg)**: Укажите `127.0.0.1` (или IP-адрес, где запущен ваш mediamtx, если он на другой машине).
        *   **Порт RTSP-сервера (для FFmpeg)**: Порт вашего mediamtx (например, `8554`).
        *   **Путь RTSP-потока**: Имя для потока на RTSP-сервере (например, `mystream_local`).
    *   Ниже будет отображаться список активных и завершенных конвертаций с их статусами, логами FFmpeg и кнопками управления (Остановить, Удалить).

### 3.2. Запуск с Docker (рекомендуется)
Инструкции по запуску с Docker находятся в разделе "9. Использование с Docker". При запуске через `docker-compose up --build` веб-интерфейс Streamlit будет доступен по адресу `http://localhost:8501` (или IP вашего Docker хоста, если он отличается).

## 4. Демонстрация потока

После успешного запуска конвертации и получения RTSP URL от вашего RTSP-сервера (например, `rtsp://127.0.0.1:8554/mystream1`, если mediamtx запущен на той же машине), вы можете просмотреть поток с помощью плееров, поддерживающих RTSP:

*   **VLC Media Player**:
    1.  Откройте VLC.
    2.  Выберите "Медиа" -> "Открыть URL-адрес сети..." (Ctrl+N).
    3.  Введите RTSP URL (например, `rtsp://127.0.0.1:8554/mystream1`).
    4.  Нажмите "Воспроизвести".

*   **ffplay** (входит в состав FFmpeg):
    ```bash
    ffplay rtsp://127.0.0.1:8554/mystream1
    ```
    Замените `127.0.0.1` на IP-адрес машины, где запущен RTSP-сервер, если вы подключаетесь с другого устройства.

## 4.1. Тестирование без реального RTMP-источника (например, дрона)

Если у вас нет под рукой реального RTMP-источника, вы можете создать тестовый RTMP-поток, используя FFmpeg для трансляции локального видеофайла на ваш запущенный сервер `mediamtx`. Затем этот поток можно будет использовать как входной для `KazStreamLink`.

**Необходимые программы (помимо Python и KazStreamLink):**
*   **FFmpeg**: Уже должен быть установлен (см. раздел 2.2).
*   **mediamtx**: Уже должен быть установлен и запущен (см. раздел 2.3).
*   **Локальный видеофайл**: Например, `testvideo.mp4`.

**Шаги:**

1.  **Убедитесь, что `mediamtx` запущен.** Он должен принимать RTMP-потоки (по умолчанию на порту `1935`) и раздавать RTSP (по умолчанию на порту `8554`).

2.  **Откройте новую командную строку/терминал.**

3.  **Запустите трансляцию вашего видеофайла на `mediamtx` с помощью FFmpeg.**
    Замените `C:\путь\к\вашему\testvideo.mp4` на актуальный путь к вашему видеофайлу:
    ```bash
    ffmpeg -re -stream_loop -1 -i "C:\путь\к\вашему\testvideo.mp4" -c:v copy -c:a aac -ar 44100 -f flv rtmp://127.0.0.1:1935/testsource
    ```
    *   `-re`: Читать входной файл с его исходной частотой кадров.
    *   `-stream_loop -1`: Бесконечно повторять видеофайл.
    *   `-i "C:\путь\к\вашему\testvideo.mp4"`: Путь к вашему локальному видеофайлу.
    *   `-c:v copy`: Копировать видеокодек без перекодирования (быстрее).
    *   `-c:a aac -ar 44100`: Перекодировать аудио в AAC с частотой дискретизации 44100 Hz (часто необходимо для совместимости с RTMP).
    *   `-f flv`: Формат вывода FLV (стандарт для RTMP).
    *   `rtmp://127.0.0.1:1935/testsource`: Адрес вашего локального `mediamtx` сервера. `testsource` — это имя потока, которое вы придумали.

    Эта команда начнет транслировать ваше видео на `mediamtx`. Теперь у вас есть RTMP-поток, доступный по адресу `rtmp://127.0.0.1:1935/testsource`. Оставьте этот терминал работать.

4.  **Запустите `KazStreamLink` (`converter.py`).**
    *   В другом терминале запустите: `python rtmp_to_rtsp_converter/converter.py`
    *   Когда скрипт запросит данные:
        *   **Введите RTMP URL источника**: `rtmp://127.0.0.1:1935/testsource`
        *   **Введите порт RTSP-сервера**: `8554` (или тот, на котором работает ваш `mediamtx`)
        *   **Введите сегмент пути RTSP для этого потока**: например, `converted_stream`

5.  **Проверьте сконвертированный RTSP-поток.**
    Откройте VLC или `ffplay` и введите RTSP URL, который будет предоставлен `mediamtx` для сконвертированного потока, например: `rtsp://127.0.0.1:8554/converted_stream`.

Теперь вы можете тестировать функциональность конвертера, используя локальный видеофайл в качестве источника.

## 5. Логирование
Скрипт ведет логирование основных событий, ошибок и статусов в консоль. Информация включает команды FFmpeg, PID процессов и сообщения об ошибках.

## 6. Поддержка нескольких потоков
Скрипт позволяет одновременно запускать и управлять несколькими процессами конвертации RTMP в RTSP. Каждой конвертации присваивается уникальный ID.

## 7. Обоснование выбора технологий
*   **Python**: Выбран для простоты разработки, управления процессами и создания CLI.
*   **FFmpeg**: Мощный и универсальный инструмент для работы с аудио и видео, включая конвертацию и стриминг протоколов. Является стандартом де-факто для таких задач.
*   **mediamtx (или аналогичный RTSP-сервер)**: Использование выделенного RTSP-сервера предпочтительнее, чем попытки реализовать RTSP-сервер непосредственно в FFmpeg или Python для производственных сценариев, так как специализированные серверы более надежны, масштабируемы и обладают большим количеством функций (например, поддержка аутентификации, перепубликация потоков и т.д.). Данный скрипт фокусируется на "склеивании" RTMP-источника с RTSP-сервером через FFmpeg.

## 8. Дальнейшие улучшения (опционально)
*   Создание `Dockerfile` и `docker-compose.yml` для контейнеризации приложения вместе с mediamtx.
*   Разработка веб-интерфейса для управления конвертациями.
*   Более детальная конфигурация параметров FFmpeg через CLI или конфигурационный файл.
*   Автоматический перезапуск процессов FFmpeg в случае сбоя.

## 9. Использование с Docker

Для упрощения развертывания и управления зависимостями (Python, FFmpeg, mediamtx) проект можно запустить с использованием Docker и Docker Compose.

### 9.1. Требования для Docker
*   **Docker**: Установлен на вашей системе. Инструкции: [Get Docker](https://docs.docker.com/get-docker/).
*   **Docker Compose**: Обычно устанавливается вместе с Docker Desktop. Если нет, инструкции: [Install Docker Compose](https://docs.docker.com/compose/install/).

### 9.2. Сборка и запуск контейнеров

1.  **Клонируйте репозиторий** (если еще не сделали) и перейдите в корневую директорию проекта `KazStreamLink`.
    ```bash
    # git clone <URL_репозитория_KazStreamLink> # Если еще не сделали
    cd KazStreamLink
    ```

2.  **Запустите сервисы с помощью Docker Compose:**
    ```bash
    docker-compose up --build
    ```
    *   `--build`: Эта опция пересобирает Docker-образ для `kazstreamlink-app` (Streamlit + FFmpeg), если были изменения в `Dockerfile` или коде приложения. При последующих запусках можно использовать просто `docker-compose up`.
    *   Эта команда запустит два контейнера:
        *   `kazstreamlink_converter_app`: Ваше Streamlit-приложение с FFmpeg.
        *   `kazstreamlink_mediamtx_server`: RTSP-сервер mediamtx.
    *   Вы увидите логи обоих сервисов в консоли. Streamlit-приложение будет доступно в вашем браузере.

    Чтобы запустить в фоновом режиме (detached mode):
    ```bash
    docker-compose up --build -d
    ```

### 9.3. Доступ к веб-интерфейсу Streamlit (при запуске через Docker)
После запуска `docker-compose up`, веб-интерфейс Streamlit будет доступен по адресу:
`http://localhost:8501` (или `http://<IP_вашего_Docker_хоста>:8501`, если Docker работает на удаленной машине или в VM).

### 9.4. Использование конвертера через Streamlit UI в Docker-окружении

1.  **Откройте веб-интерфейс** в браузере (`http://localhost:8501`).
2.  **Добавьте новую конвертацию:**
    *   **RTMP URL источника**: Укажите ваш RTMP-поток. Например, если вы транслируете тестовый поток с хост-машины (см. раздел 9.5), это может быть `rtmp://host.docker.internal:1935/testsource_docker` (для Windows/Mac) или `rtmp://<IP_хоста_в_сети_bridge>:1935/testsource_docker` (для Linux, где `<IP_хоста_в_сети_bridge>` обычно что-то вроде `172.17.0.1`). Проще всего, если RTMP-источник также является Docker-сервисом или доступен из Docker-сети `mediamtx`.
    *   **Хост RTSP-сервера (для FFmpeg)**: По умолчанию установлено `mediamtx`. Это имя сервиса `mediamtx` в `docker-compose.yml`, и Docker обеспечит разрешение этого имени в IP-адрес контейнера `mediamtx`. **Не меняйте это значение, если используете предоставленный `docker-compose.yml`.**
    *   **Порт RTSP-сервера (для FFmpeg)**: По умолчанию `8554`. Это внутренний порт `mediamtx` в Docker-сети. **Не меняйте это значение.**
    *   **Путь RTSP-потока (на сервере)**: Придумайте имя для потока, например, `mystream_docker`.
3.  Нажмите "Начать конвертацию".

4.  **Просмотр сконвертированного потока:**
    *   RTSP-сервер `mediamtx` (в контейнере) публикует свой порт `8554` на порт `8554` вашей хост-машины.
    *   Поэтому для просмотра потока в VLC или ffplay используйте IP-адрес вашей хост-машины (или `127.0.0.1`, если VLC/ffplay запущены на той же машине, где Docker) и опубликованный порт:
        `rtsp://127.0.0.1:8554/mystream_docker` (или тот путь, который вы указали).

### 9.5. Тестирование: Отправка RTMP-потока с хост-машины в Docker-контейнер mediamtx

Если вы хотите использовать FFmpeg на вашей хост-машине для отправки тестового RTMP-потока в контейнер `mediamtx` (который запущен через `docker-compose`):

1.  Убедитесь, что `docker-compose up` запущен и порт `1935` для `mediamtx` опубликован (это сделано в `docker-compose.yml`).
2.  На вашей **хост-машине** (не в Docker) выполните команду FFmpeg для трансляции локального видеофайла:
    ```bash
    ffmpeg -re -stream_loop -1 -i "C:\путь\к\вашему\testvideo.mp4" -c:v copy -c:a aac -ar 44100 -f flv rtmp://127.0.0.1:1935/test_from_host
    ```
    *   Здесь `rtmp://127.0.0.1:1935/test_from_host` указывает на порт `1935` вашей хост-машины, который Docker перенаправляет в контейнер `mediamtx`. `test_from_host` - это имя потока.

3.  Теперь в веб-интерфейсе Streamlit (`http://localhost:8501`) добавьте новую конвертацию:
    *   **RTMP URL источника**: `rtmp://mediamtx:1935/test_from_host`
        *   **Объяснение**: Контейнер `kazstreamlink-app` (где работает Streamlit и FFmpeg-конвертер) обращается к контейнеру `mediamtx` по его имени сервиса (`mediamtx`) и внутреннему порту (`1935`) в Docker-сети. Поток `test_from_host` уже находится внутри `mediamtx`.
    *   **Хост RTSP-сервера (для FFmpeg)**: `mediamtx` (оставьте по умолчанию)
    *   **Порт RTSP-сервера (для FFmpeg)**: `8554` (оставьте по умолчанию)
    *   **Путь RTSP-потока (на сервере)**: например, `converted_host_test`

4.  Нажмите "Начать конвертацию".

5.  Просматривайте итоговый RTSP-поток по адресу: `rtsp://127.0.0.1:8554/converted_host_test` в VLC или ffplay.

### 9.6. Остановка сервисов
В терминале, где запущен `docker-compose up` (если не в режиме `-d`), нажмите `Ctrl+C`.
Если запускали с `-d` (в фоновом режиме), используйте команду в корневой директории проекта:
```bash
docker-compose down
```
Эта команда остановит и удалит контейнеры, но не удалит образы и сети (если не указать доп. флаги).
