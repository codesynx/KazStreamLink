# KazStreamLink: Конвертер RTMP в RTSP

Простой сервис для конвертации видеопотоков из формата RTMP в формат RTSP.
Сервис использует FFmpeg для фактической конвертации и предполагает, что для раздачи RTSP-потока используется отдельный RTSP-сервер, такой как [mediamtx](https://github.com/bluenviron/mediamtx) (ранее известный как rtsp-simple-server).

## 1. Требования

*   **Python 3.6+**
*   **FFmpeg**: Установлен и доступен в системном `PATH`.
*   **RTSP-сервер** (рекомендуется mediamtx): Запущен и настроен для приема потоков. По умолчанию mediamtx слушает на порту `8554`.

## 2. Установка и настройка

### 2.1. Клонирование проекта (если применимо)
```bash
git clone <URL_репозитория_KazStreamLink>
cd KazStreamLink
```

### 2.2. Установка FFmpeg
Инструкции по установке FFmpeg зависят от вашей операционной системы:
*   **Windows**: Скачайте сборку с [официального сайта FFmpeg](https://ffmpeg.org/download.html) и добавьте путь к `ffmpeg.exe` в переменную окружения `PATH`.
*   **Linux (Ubuntu/Debian)**:
    ```bash
    sudo apt update
    sudo apt install ffmpeg
    ```
*   **macOS (используя Homebrew)**:
    ```bash
    brew install ffmpeg
    ```

### 2.3. Установка и запуск RTSP-сервера (mediamtx)
1.  Скачайте последнюю версию mediamtx для вашей ОС со страницы [релизов mediamtx](https://github.com/bluenviron/mediamtx/releases).
2.  Распакуйте архив и запустите исполняемый файл `mediamtx` (или `mediamtx.exe` для Windows).
    ```bash
    ./mediamtx
    ```
    По умолчанию mediamtx будет слушать RTSP-соединения на порту `8554` и RTMP на `1935`. Конфигурационный файл `mediamtx.yml` позволяет настроить эти и другие параметры. Для нашего случая, Python-скрипт будет отправлять поток на `rtsp://127.0.0.1:8554/имя_потока`.

## 3. Запуск конвертера

Скрипт `converter.py` находится в директории `rtmp_to_rtsp_converter`.

```bash
python rtmp_to_rtsp_converter/converter.py
```

После запуска появится командный интерфейс (CLI) для управления конвертациями:

```
Конвертер RTMP в RTSP (CLI)
---------------------------------
Требуется отдельно запущенный RTSP-сервер (например, mediamtx).
FFmpeg будет получать RTMP и отправлять на rtsp://127.0.0.1:<rtsp_port>/<rtsp_path>
Итоговый RTSP поток будет доступен с RTSP-сервера по этому адресу.
---------------------------------

Опции:
1. Начать новую конвертацию
2. Остановить конвертацию
3. Посмотреть статусы
4. Выход
Введите выбор:
```

### 3.1. Начало новой конвертации
1.  Выберите опцию `1`.
2.  Введите URL входного RTMP-потока (например, `rtmp://some.server/live/streamkey`).
3.  Введите порт вашего запущенного RTSP-сервера (например, `8554`, если используете mediamtx по умолчанию).
4.  Введите желаемый путь для RTSP-потока (например, `mystream1`). Это имя, под которым поток будет доступен на RTSP-сервере.

После этого FFmpeg начнет процесс конвертации. Скрипт сообщит, по какому адресу RTSP-сервер должен предоставлять поток (например, `rtsp://<ip_вашего_rtsp_сервера>:8554/mystream1`).

### 3.2. Остановка конвертации
1.  Выберите опцию `2`.
2.  Введите ID потока, который хотите остановить (например, `stream_0`). ID присваивается автоматически при создании конвертации.

### 3.3. Просмотр статусов
Выберите опцию `3` для отображения списка всех активных и завершенных конвертаций и их статусов.

## 4. Демонстрация потока

После успешного запуска конвертации и получения RTSP URL от вашего RTSP-сервера (например, `rtsp://127.0.0.1:8554/mystream1`, если mediamtx запущен на той же машине), вы можете просмотреть поток с помощью плееров, поддерживающих RTSP:

*   **VLC Media Player**:
    1.  Откройте VLC.
    2.  Выберите "Медиа" -> "Открыть URL-адрес сети..." (Ctrl+N).
    3.  Введите RTSP URL (например, `rtsp://127.0.0.1:8554/mystream1`).
    4.  Нажмите "Воспроизвести".

*   **ffplay** (входит в состав FFmpeg):
    ```bash
    ffplay rtsp://127.0.0.1:8554/mystream1
    ```
    Замените `127.0.0.1` на IP-адрес машины, где запущен RTSP-сервер, если вы подключаетесь с другого устройства.

## 4.1. Тестирование без реального RTMP-источника (например, дрона)

Если у вас нет под рукой реального RTMP-источника, вы можете создать тестовый RTMP-поток, используя FFmpeg для трансляции локального видеофайла на ваш запущенный сервер `mediamtx`. Затем этот поток можно будет использовать как входной для `KazStreamLink`.

**Необходимые программы (помимо Python и KazStreamLink):**
*   **FFmpeg**: Уже должен быть установлен (см. раздел 2.2).
*   **mediamtx**: Уже должен быть установлен и запущен (см. раздел 2.3).
*   **Локальный видеофайл**: Например, `testvideo.mp4`.

**Шаги:**

1.  **Убедитесь, что `mediamtx` запущен.** Он должен принимать RTMP-потоки (по умолчанию на порту `1935`) и раздавать RTSP (по умолчанию на порту `8554`).

2.  **Откройте новую командную строку/терминал.**

3.  **Запустите трансляцию вашего видеофайла на `mediamtx` с помощью FFmpeg.**
    Замените `C:\путь\к\вашему\testvideo.mp4` на актуальный путь к вашему видеофайлу:
    ```bash
    ffmpeg -re -stream_loop -1 -i "C:\путь\к\вашему\testvideo.mp4" -c:v copy -c:a aac -ar 44100 -f flv rtmp://127.0.0.1:1935/testsource
    ```
    *   `-re`: Читать входной файл с его исходной частотой кадров.
    *   `-stream_loop -1`: Бесконечно повторять видеофайл.
    *   `-i "C:\путь\к\вашему\testvideo.mp4"`: Путь к вашему локальному видеофайлу.
    *   `-c:v copy`: Копировать видеокодек без перекодирования (быстрее).
    *   `-c:a aac -ar 44100`: Перекодировать аудио в AAC с частотой дискретизации 44100 Hz (часто необходимо для совместимости с RTMP).
    *   `-f flv`: Формат вывода FLV (стандарт для RTMP).
    *   `rtmp://127.0.0.1:1935/testsource`: Адрес вашего локального `mediamtx` сервера. `testsource` — это имя потока, которое вы придумали.

    Эта команда начнет транслировать ваше видео на `mediamtx`. Теперь у вас есть RTMP-поток, доступный по адресу `rtmp://127.0.0.1:1935/testsource`. Оставьте этот терминал работать.

4.  **Запустите `KazStreamLink` (`converter.py`).**
    *   В другом терминале запустите: `python rtmp_to_rtsp_converter/converter.py`
    *   Когда скрипт запросит данные:
        *   **Введите RTMP URL источника**: `rtmp://127.0.0.1:1935/testsource`
        *   **Введите порт RTSP-сервера**: `8554` (или тот, на котором работает ваш `mediamtx`)
        *   **Введите сегмент пути RTSP для этого потока**: например, `converted_stream`

5.  **Проверьте сконвертированный RTSP-поток.**
    Откройте VLC или `ffplay` и введите RTSP URL, который будет предоставлен `mediamtx` для сконвертированного потока, например: `rtsp://127.0.0.1:8554/converted_stream`.

Теперь вы можете тестировать функциональность конвертера, используя локальный видеофайл в качестве источника.

## 5. Логирование
Скрипт ведет логирование основных событий, ошибок и статусов в консоль. Информация включает команды FFmpeg, PID процессов и сообщения об ошибках.

## 6. Поддержка нескольких потоков
Скрипт позволяет одновременно запускать и управлять несколькими процессами конвертации RTMP в RTSP. Каждой конвертации присваивается уникальный ID.

## 7. Обоснование выбора технологий
*   **Python**: Выбран для простоты разработки, управления процессами и создания CLI.
*   **FFmpeg**: Мощный и универсальный инструмент для работы с аудио и видео, включая конвертацию и стриминг протоколов. Является стандартом де-факто для таких задач.
*   **mediamtx (или аналогичный RTSP-сервер)**: Использование выделенного RTSP-сервера предпочтительнее, чем попытки реализовать RTSP-сервер непосредственно в FFmpeg или Python для производственных сценариев, так как специализированные серверы более надежны, масштабируемы и обладают большим количеством функций (например, поддержка аутентификации, перепубликация потоков и т.д.). Данный скрипт фокусируется на "склеивании" RTMP-источника с RTSP-сервером через FFmpeg.

## 8. Дальнейшие улучшения (опционально)
*   Создание `Dockerfile` и `docker-compose.yml` для контейнеризации приложения вместе с mediamtx.
*   Разработка веб-интерфейса для управления конвертациями.
*   Более детальная конфигурация параметров FFmpeg через CLI или конфигурационный файл.
*   Автоматический перезапуск процессов FFmpeg в случае сбоя.
